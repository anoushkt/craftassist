# Android App for use with the [Minecraft Project](https://github.com/fairinternal/minecraft)
## Set Up the Project
Do this *before* setting up the Android App.
Go through the project's [installation](https://github.com/fairinternal/minecraft#installation--getting-started) with a few modifications specified below.

**When going through the project setup, please do not use ports 2556 or 8000 as these will be used by the android app** (You can use the default ports in the setup process).

Before [running the cuberite instance](https://github.com/fairinternal/minecraft#installation--getting-started) (after you have loaded the environment), run:
```
pip install qrcode[pil]
```
(which is needed by the plugin to generate a QR code image that can be scanned).

At [Run the Cuberite instance](https://github.com/fairinternal/minecraft#installation--getting-started) step of the project's installation, run the following command instead:
```
python ./python/cuberite_process.py --add-plugin minecraft_asr_app
```
which starts an instance of cuberite listening on `localhost:25565` with the plugin `minecraft_asr_app` enabled.

Continue to follow the rest of the setup instructions from [Connecting your Minecraft game client](https://github.com/fairinternal/minecraft#connecting-your-minecraft-game-client-so-you-can-see-whats-happening).

## About the Android App
With this android app, Minecraft players can interact and chat with the bot using voice as input. The app uses Android's default [ASR model](https://developer.android.com/reference/android/speech/SpeechRecognizer) to parse voice to text which is then sent as a chat message from the player in the game through the specified IP address and port.

Functionality:
- Speech recognition
- Scanning a QR code image that is generated by the plugin to automatically populate the IP address, port, and username field (or manually enter the IP address, port, and username to connect)
- Username specified must be a player within the game for the chat message to be sent

You can install and use the app on a physical android device or on an emulator (android virtual device on your computer). An emulator has limited capabilities and might not support all the functionalities such as the QR code (which requires camera access) and ASR (requires a microphone).

## Prerequisites
Install the "Command line tools only" from the [Android SDK](https://developer.android.com/studio#downloads). If you have Android Studio then you should already have the Android SDK.

Make sure your phone is connected to your laptop. From `minecraft/android/`, run:
```
adb install -t app-debug.apk
```
to install the app to your phone.


### (developer) to make changes to the app
In [Android Studio](https://developer.android.com/studio), open an existing project at the STT folder.

Tools > Android SDK > SDK Tools: make sure Google Play services is checked

#### Setting up Firebase ML Kit
Follow the steps for option 1: Adding Firebase through the Firebase console (https://firebase.google.com/docs/android/setup). The necessary dependencies/modifications to the build.gradle files should already be done- just need to register the app and download the config file (google-services.json) and add it inside the app folder of the project.

#### Rebuilding the APK
After you make changes, rebuild the APK and update it so that others can easily use the app.
From inside the STTApp folder `minecraft/android/STT/`, build a new debug apk by running the following command.
```
./gradlew assembleDebug
```
The APK is located in app/build/outputs/apk/debug/app-debug.apk
Copy it into the android directory and replace the old one so others can use the updated version!

## Usage
### Connecting your phone to the minecraft_asr_app plugin
#### Physical device
Download a [terminal app](https://play.google.com/store/apps/details?id=com.termux).
If Cuberite is running remotely on a FAIR devserver, using the terminal app, create an ssh tunnel from the port that the plugin is listening on to your phone's localhost:
```
ssh -fN -L 2556:100.97.69.35:2556 -J meganu@prn-fairjmp03.thefacebook.com meganu@100.97.69.35
```
(Replace `100.97.69.35` with your devserver's IP and `meganu` with your username.)

To use the QR Code functionality, create another ssh tunnel from the FAIR devserver port the plugin has served the webpage on (default 8000) to your machine's localhost:
```
ssh -fN -L 8000:100.97.69.35:8000 -J prn-fairjmp03 meganu@100.97.69.35
```
(Replace `100.97.69.35` with your devserver's IP and `meganu` with your username.)

The plugin executes a python script in the background for serving the QR Code webpage (port 8000) so after the cuberite instance stops running, remember to kill the process that is running as shown below:

Get the process id running at port 8000:
```
lsof -i:8000
```
and then kill it:
```
kill <process id from above>
```

#### Emulator
If Cuberite is running remotely on a FAIR devserver, create an ssh tunnel from the port that the plugin is listening on to your machine's localhost:
```
ssh -fN -L 2556:100.97.69.35:2556 -J prn-fairjmp03 meganu@100.97.69.35
```
(Replace `100.97.69.35` with your devserver's IP and `meganu` with your username.)

### Using the App
The `minecraft_asr_app` cuberite plugin starts a server which listens on a specified port (default 2556). For the app to send chat messages, it must communicate with the Cuberite plugin.

Connecting: In the app, either use the QR code scanning functionality to populate the IP address and port where the Cuberite plugin server is listening, and the player's username, or enter in the details manually.
Connect using the QR Code by navigating to the address where the webserver has started (localhost:8000). If you are using a FAIR devserver make sure you have created an ssh tunnel for that port.

Chatting: Press the "record" button to use the ASR functionality or manually type in the chat message you would like to send to the bot. press "submit" to send the chat (to the `minecraft_asr_app` cuberite plugin which sends it to the Minecraft client).

If you are using an emulator, for the IP address, use `10.0.2.2` (which is the emulator's localhost). Please note that it will not support camera (QR Code) or microphone (ASR) capabilities. You can still send in-game chats by manually typing in the information to connect and the chat message you would like to send.


## Built with
- [qrcode python module](https://pypi.org/project/qrcode/)
- [Firebase ML Kit](https://firebase.google.com/products/ml-kit)
